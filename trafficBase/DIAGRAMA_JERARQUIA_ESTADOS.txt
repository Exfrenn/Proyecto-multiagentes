# 🌳 Jerarquía de Estados del Agente Car
## Diagrama Visual Completo

```
════════════════════════════════════════════════════════════════════════════
                        MÁQUINA DE ESTADOS JERÁRQUICA
════════════════════════════════════════════════════════════════════════════

NIVEL 1: ESTADOS PRINCIPALES (MainState)
────────────────────────────────────────────────────────────────────────────

    ┌─────────────────────────────────────────────────────────────────┐
    │                         ACTIVE                                  │
    │  (El carro está activo y navegando hacia su destino)            │
    │                                                                 │
    │  ┌───────────────────────────────────────────────────────────┐ │
    │  │  NIVEL 2: SUB-ESTADOS DE NAVEGACIÓN (NavigatingState)    │ │
    │  │                                                           │ │
    │  │  ┌─────────────────────────────────────────────────┐     │ │
    │  │  │  🚗 MOVING                                      │     │ │
    │  │  │  - Moviéndose normalmente                       │     │ │
    │  │  │  - Siguiendo la dirección de la carretera       │     │ │
    │  │  │  - Acción: move                                 │     │ │
    │  │  └─────────────────────────────────────────────────┘     │ │
    │  │                                                           │ │
    │  │  ┌─────────────────────────────────────────────────┐     │ │
    │  │  │  🚦 WAITING_TRAFFIC_LIGHT                       │     │ │
    │  │  │  - Esperando que el semáforo cambie a verde     │     │ │
    │  │  │  - Incrementa waiting_time                      │     │ │
    │  │  │  - Acción: wait                                 │     │ │
    │  │  └─────────────────────────────────────────────────┘     │ │
    │  │                                                           │ │
    │  │  ┌─────────────────────────────────────────────────┐     │ │
    │  │  │  🚙 AVOIDING_COLLISION                          │     │ │
    │  │  │  - Hay otro carro adelante                      │     │ │
    │  │  │  - Esperando que se despeje                     │     │ │
    │  │  │  - Acción: wait                                 │     │ │
    │  │  └─────────────────────────────────────────────────┘     │ │
    │  │                                                           │ │
    │  │  ┌─────────────────────────────────────────────────┐     │ │
    │  │  │  🚧 BLOCKED                                     │     │ │
    │  │  │  - No hay carretera válida                      │     │ │
    │  │  │  - Fuera de límites del grid                    │     │ │
    │  │  │  - Acción: wait                                 │     │ │
    │  │  └─────────────────────────────────────────────────┘     │ │
    │  │                                                           │ │
    │  │  ┌─────────────────────────────────────────────────┐     │ │
    │  │  │  🗺️ PLANNING_ROUTE                              │     │ │
    │  │  │  - Planificando/recalculando ruta (futuro)      │     │ │
    │  │  │  - Ejecutando algoritmo de pathfinding          │     │ │
    │  │  │  - Acción: wait                                 │     │ │
    │  │  └─────────────────────────────────────────────────┘     │ │
    │  │                                                           │ │
    │  └───────────────────────────────────────────────────────────┘ │
    │                                                                 │
    └─────────────────────────────────────────────────────────────────┘
                                    │
                                    │ Llegó al destino
                                    ▼
    ┌─────────────────────────────────────────────────────────────────┐
    │                         ARRIVED                                 │
    │  (Estado final: el carro llegó a su destino)                    │
    │  - No tiene sub-estados                                         │
    │  - Acción: stop                                                 │
    │  - No más transiciones                                          │
    └─────────────────────────────────────────────────────────────────┘


════════════════════════════════════════════════════════════════════════════
                    DIAGRAMA DE TRANSICIONES DETALLADO
════════════════════════════════════════════════════════════════════════════

                              ┌─────────┐
                              │  START  │
                              └────┬────┘
                                   │
                                   ▼
                    ┌──────────────────────────┐
                    │   ACTIVE → MOVING        │
                    └────┬─────────────────────┘
                         │
        ┌────────────────┼────────────────┬──────────────┬──────────────┐
        │                │                │              │              │
        │ Semáforo rojo  │ Carro adelante │ Sin carretera│ Planificando │
        ▼                ▼                ▼              ▼              ▼
┌───────────────┐  ┌──────────────┐  ┌──────────┐  ┌──────────────┐
│ACTIVE →       │  │ACTIVE →      │  │ACTIVE →  │  │ACTIVE →      │
│WAITING_       │  │AVOIDING_     │  │BLOCKED   │  │PLANNING_     │
│TRAFFIC_LIGHT  │  │COLLISION     │  │          │  │ROUTE         │
└───────┬───────┘  └──────┬───────┘  └────┬─────┘  └──────┬───────┘
        │                 │               │               │
        │ Semáforo verde  │ Se despejó    │ Ruta válida   │ Ruta lista
        │                 │               │               │
        └─────────────────┴───────────────┴───────────────┘
                         │
                         ▼
                ┌─────────────────┐
                │  ACTIVE →       │
                │  MOVING         │
                └────────┬────────┘
                         │
                         │ Llegó al destino
                         ▼
                ┌─────────────────┐
                │    ARRIVED      │
                └─────────────────┘
                   (ESTADO FINAL)


════════════════════════════════════════════════════════════════════════════
                    FLUJO DE DECISIÓN (decide_action)
════════════════════════════════════════════════════════════════════════════

    ┌─────────────────────────────────────────────────────────────┐
    │  1. PERCIBIR ENTORNO                                        │
    │     - Carretera actual                                      │
    │     - Semáforos                                             │
    │     - Carros adelante                                       │
    │     - Siguiente celda                                       │
    └────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
    ┌─────────────────────────────────────────────────────────────┐
    │  2. NIVEL 1: ¿Llegué al destino?                            │
    └────────────────────────┬────────────────────────────────────┘
                             │
                    ┌────────┴────────┐
                    │                 │
                   SÍ                NO
                    │                 │
                    ▼                 ▼
         ┌─────────────────┐   ┌──────────────────────────────┐
         │ ARRIVED         │   │ 3. NIVEL 2: Evaluar          │
         │ Acción: stop    │   │    sub-estados               │
         └─────────────────┘   └──────┬───────────────────────┘
                                      │
                    ┌─────────────────┼─────────────────┐
                    │                 │                 │
                    ▼                 ▼                 ▼
         ┌──────────────────┐  ┌─────────────┐  ┌──────────────┐
         │ ¿En carretera?   │  │ ¿Siguiente  │  │ ¿Carros      │
         │ NO → BLOCKED     │  │  celda OK?  │  │  adelante?   │
         │      wait        │  │ NO→ BLOCKED │  │ SÍ→ AVOIDING │
         └──────────────────┘  └─────────────┘  └──────────────┘
                    │                 │                 │
                    └─────────────────┼─────────────────┘
                                      │
                                      ▼
                            ┌──────────────────┐
                            │ ¿Semáforo rojo?  │
                            │ SÍ → WAITING     │
                            │      wait        │
                            └────────┬─────────┘
                                     │
                                    NO
                                     │
                                     ▼
                            ┌──────────────────┐
                            │ TODO DESPEJADO   │
                            │ MOVING           │
                            │ Acción: move     │
                            └──────────────────┘


════════════════════════════════════════════════════════════════════════════
                        TABLA DE PRIORIDADES
════════════════════════════════════════════════════════════════════════════

┌──────┬─────────────────────────┬────────────────┬──────────┬─────────┐
│ Prio │ Condición               │ Estado Destino │ Acción   │ Nivel   │
├──────┼─────────────────────────┼────────────────┼──────────┼─────────┤
│  1   │ Llegó al destino        │ ARRIVED        │ stop     │ Nivel 1 │
├──────┼─────────────────────────┼────────────────┼──────────┼─────────┤
│  2   │ No está en carretera    │ BLOCKED        │ wait     │ Nivel 2 │
├──────┼─────────────────────────┼────────────────┼──────────┼─────────┤
│  3   │ Sin siguiente celda     │ BLOCKED        │ wait     │ Nivel 2 │
├──────┼─────────────────────────┼────────────────┼──────────┼─────────┤
│  4   │ Siguiente sin carretera │ BLOCKED        │ wait     │ Nivel 2 │
├──────┼─────────────────────────┼────────────────┼──────────┼─────────┤
│  5   │ Carros adelante         │ AVOIDING_COL.  │ wait     │ Nivel 2 │
├──────┼─────────────────────────┼────────────────┼──────────┼─────────┤
│  6   │ Semáforo en rojo (TODO) │ WAITING_LIGHT  │ wait     │ Nivel 2 │
├──────┼─────────────────────────┼────────────────┼──────────┼─────────┤
│  7   │ Camino despejado        │ MOVING         │ move     │ Nivel 2 │
└──────┴─────────────────────────┴────────────────┴──────────┴─────────┘


════════════════════════════════════════════════════════════════════════════
                    EJEMPLO DE EJECUCIÓN PASO A PASO
════════════════════════════════════════════════════════════════════════════

Paso 1:
  Estado: ACTIVE → MOVING
  Percepción: Carretera OK, sin obstáculos
  Decisión: move
  Resultado: Avanza 1 celda, steps_taken = 1

Paso 2:
  Estado: ACTIVE → MOVING
  Percepción: Carretera OK, carro adelante detectado
  Decisión: wait
  Resultado: ACTIVE → AVOIDING_COLLISION, waiting_time = 1

Paso 3:
  Estado: ACTIVE → AVOIDING_COLLISION
  Percepción: Carro adelante aún presente
  Decisión: wait
  Resultado: Permanece en AVOIDING_COLLISION, waiting_time = 2

Paso 4:
  Estado: ACTIVE → AVOIDING_COLLISION
  Percepción: Carro adelante se movió, camino despejado
  Decisión: move
  Resultado: ACTIVE → MOVING, avanza, waiting_time = 0

Paso 5:
  Estado: ACTIVE → MOVING
  Percepción: Llegó al destino
  Decisión: stop
  Resultado: ARRIVED, steps_taken = 2

Paso 6+:
  Estado: ARRIVED
  Decisión: stop
  Resultado: No hace nada (estado final)


════════════════════════════════════════════════════════════════════════════
                        MÉTODOS DISPONIBLES
════════════════════════════════════════════════════════════════════════════

CONSULTA DE ESTADOS:
  car.is_active()      → bool  # ¿Está en ACTIVE?
  car.is_arrived()     → bool  # ¿Está en ARRIVED?
  car.is_moving()      → bool  # ¿Está en ACTIVE → MOVING?
  car.is_waiting()     → bool  # ¿Está esperando? (WAITING/AVOIDING)

TRANSICIONES:
  car.transition_to_arrived()              # ACTIVE → ARRIVED
  car.transition_navigating_state(state)   # Cambiar sub-estado

INFORMACIÓN:
  car.get_current_state_description()      # String legible del estado

PERCEPCIÓN:
  car.perceive_environment()               # Dict con info del entorno

DECISIÓN:
  car.decide_action(perception)            # 'move', 'wait', o 'stop'

EJECUCIÓN:
  car.execute_action(action, perception)   # Ejecuta la acción

CICLO COMPLETO:
  car.step()                               # Percibir → Decidir → Actuar


════════════════════════════════════════════════════════════════════════════
